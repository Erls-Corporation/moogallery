/*
---
description: moogallery creates an interactive gallery of images. Given the images and thumbs paths and some information, the thumbs are loaded sequentially and inserted in a table structure automatically sized according to the size of the container, then events are added in order to manage tips, lightbox widget (and navigation through images) and show images' meta information.

license: MIT-style

authors:
- abidibo <dev@abidibo.net>

requires:
- core/1.3

provides:
- moogallery

...

For documentation, demo and download link please visit http://www.abidibo.net/projects/js/moogallery

*/
var moogallery=new Class({Implements:[Options,Events],options:{show_bullets:true,onComplete:function(){}},initialize:function(a,c,b){this.container=typeOf(a)=="element"?a:$(a);this.container.setStyle("padding","0");this.images_opt=c;this.setOptions(b);this.images=[];this.thumbs=[];this.max_z_index=this.getMaxZindex();this.table=new Element("table",{"class":"moogallery"}).inject(this.container);this.tr=new Element("tr").inject(this.table);this.tr_width=0;this.container_width=this.container.getCoordinates().width;this.addEvent("image_rendered",function(d){if(typeOf(this.images_opt[d])!="null"){this.renderImage(this.images_opt[d])}else{this.fireEvent("complete")}});this.renderImage(this.images_opt[0])},getMaxZindex:function(){var a=0;$$("body *").each(function(b){if(b.getStyle("z-index").toInt()){a=Math.max(a,b.getStyle("z-index").toInt())}});return a},getViewport:function(){var b,a,d,c,f,e;if(typeof window.innerWidth!="undefined"){b=window.innerWidth,a=window.innerHeight}else{if(typeof document.documentElement!="undefined"&&typeof document.documentElement.clientWidth!="undefined"&&document.documentElement.clientWidth!=0){b=document.documentElement.clientWidth,a=document.documentElement.clientHeight}}c=typeof self.pageYOffset!="undefined"?self.pageYOffset:(document.documentElement&&document.documentElement.scrollTop)?document.documentElement.scrollTop:document.body.clientHeight;d=typeof self.pageXOffset!="undefined"?self.pageXOffset:(document.documentElement&&document.documentElement.scrollTop)?document.documentElement.scrollLeft:document.body.clientWidth;f=d+b/2;e=c+a/2;return{width:b,height:a,left:d,top:c,cX:f,cY:e}},renderImage:function(c){var b=new Image();var a=new Image();this.setTip(a,c);this.setLightbox(a,c);b.src=c.img;a.src=c.thumb;this.images.push(b);this.thumbs.push(a);a.onload=function(){var d=new Element("td");d.inject(this.tr);a.inject(d);if(this.table.getCoordinates().width>=this.container_width){d.dispose();this.tr=new Element("tr").inject(this.table);d.inject(this.tr)}this.fireEvent("image_rendered",this.images_opt.indexOf(c)+1)}.bind(this)}.protect(),setTip:function(a,c){var b=new Element("div",{"class":"moogallery_tip"});b.set("html","<b>"+c.title+"</b>");a.addEvents({mousemove:function(d){b.setStyles({position:"absolute",top:(d.page.y+10)+"px",left:(d.page.x+10)+"px","z-index":this.max_z_index++});b.inject(document.body)}.bind(this),mouseout:function(d){b.dispose()}})}.protect(),setLightbox:function(a,b){a.addEvent("click",function(){this.renderOverlay(this.renderLightbox.bind(this,b))}.bind(this))}.protect(),renderOverlay:function(b){var a=document.getScrollSize();this.overlay=new Element("div",{"class":"moogallery_overlay"});this.overlay.setStyles({position:"absolute",top:0,left:0,"z-index":this.max_z_index++,width:a.x,height:a.y,opacity:0});this.overlay.inject(document.body);var c=new Fx.Tween(this.overlay,{property:"opacity"});c.start(0,0.9).chain(b)},renderLightbox:function(a){this.lightbox_container=new Element("div.moogallery_lightbox_container").setStyles({visibility:"hidden",position:"absolute",overflow:"hidden",margin:"0"});this.lightbox_container.inject(document.body);this.lightbox_container.addEvent("click",function(c){if(c.target.get("tag")=="a"){return true}var b=this.lightbox_container.getCoordinates();if(c.page.x<b.left+b.width/2){if(this.index==0){return false}this.changeImage(this.index-1)}else{if(this.index==this.images.length-1){return false}this.changeImage(this.index+1)}}.bind(this));this.index=this.images_opt.indexOf(a);this.renderLightboxContainer()},renderLightboxContainer:function(){img_opt=this.images_opt[this.index];var h=this.images[this.index];var o=new Element("div.moogallery_lightbox_info");var n=new Element("p.moogallery_lightbox_info_title").set("html",img_opt.title);var f=typeOf(img_opt.description)==="null"?"":img_opt.description;var g=new Element("div.moogallery_lightbox_info_description").set("html",f);var q=typeOf(img_opt.credits)==="null"?"":img_opt.credits;var p=new Element("p.moogallery_lightbox_info_credits").set("html",q);o.adopt(n,g,p);var e=this.renderNavigation(img_opt);var l=new Element("div").setStyle("opacity","0").inject(this.lightbox_container);l.adopt(h,e,o);var d=this.lightbox_container.getStyle("padding").toInt()*2+this.lightbox_container.getStyle("border-width").toInt()*2;var j=h.getCoordinates().width;if(this.lightbox_container.getStyle("visibility")=="hidden"){var m=20;var i=20+d;var c=this.getViewport();this.lightbox_container.setStyles({width:m+"px",height:m+"px",top:(c.cY-i/2)+"px",left:(c.cX-i/2)+"px",visibility:"visible","z-index":this.max_z_index++})}var k=this.lightbox_container.getCoordinates().width;var a=this.lightbox_container.getCoordinates().height;var b=new Fx.Morph(this.lightbox_container,{duration:"short"});b.start({width:j,left:this.lightbox_container.getStyle("left").toInt()-(j+d-k)/2}).chain(function(){l.adopt(e,o);var r=l.getCoordinates().height;b.start({height:r,top:this.lightbox_container.getStyle("top").toInt()-(r+d-a)/2,}).chain(function(){l.fade("in")})}.bind(this));this.overlay.addEvent("click",function(s){var r=new DOMEvent(s);if(r.target!=this.container){this.lightbox_container.dispose();var t=new Fx.Tween(this.overlay,{property:"opacity"});t.start(0.9,0).chain(function(){this.overlay.dispose()}.bind(this))}}.bind(this))},renderNavigation:function(f){var c=this.images_opt.indexOf(f);var e=new Element("div.moogallery_nav");var g=(c+1)+"/"+this.images_opt.length;var a=new Element("div.moogallery_nav_info").set("text",g);e.adopt(a);if(this.options.show_bullets){var b=new Element("table.moogallery_nav_table");var d=new Element("tr").inject(b);this.images.each(function(j,k){var l=new Element("td").inject(d);var h=new Element("div.moogallery_nav_bullet").inject(l);if(k==c){h.addClass("bullet_selected")}else{h.addEvent("click",function(i){i.stopPropagation();this.changeImage(k)}.bind(this))}}.bind(this));b.inject(e)}return e}.protect(),changeImage:function(a){this.index=a;var b=new Fx.Tween(this.lightbox_container.getChildren("div")[0],{property:"opacity",duration:"short"});b.start(1,0).chain(function(){this.lightbox_container.empty();this.renderLightboxContainer()}.bind(this))}});
